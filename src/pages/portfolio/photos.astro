---
import BaseHead from '../../components/BaseHead.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import { readdir } from 'node:fs/promises';
import { extname, resolve } from 'node:path';

const photosDir = resolve(process.cwd(), 'public', 'media', 'photos');
const allowedExt = new Set(['.jpg', '.jpeg', '.png', '.webp', '.gif', '.avif']);

let subjects: Array<{ slug: string; label: string; count: number }> = [];
try {
	const directories = (await readdir(photosDir, { withFileTypes: true }))
		.filter((entry) => entry.isDirectory())
		.map((entry) => entry.name)
		.sort((a, b) => a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' }));

	const subjectRows = await Promise.all(
		directories.map(async (dir) => {
			const files = await readdir(resolve(photosDir, dir), { withFileTypes: true });
			const count = files
				.filter((entry) => entry.isFile())
				.map((entry) => entry.name)
				.filter((name) => allowedExt.has(extname(name).toLowerCase())).length;

			return {
				slug: dir,
				label: dir.replace(/[-_]+/g, ' ').replace(/\b\w/g, (c) => c.toUpperCase()),
				count
			};
		})
	);

	subjects = subjectRows.filter((row) => row.count > 0);
} catch {
	subjects = [];
}
---

<!doctype html>
<html lang="en">
	<head>
		<BaseHead
			title="Portfolio Categories | ATXPIXEL.COM"
			description="Browse photo portfolios by subject."
		/>
		<style>
			.subject-grid {
				display: grid;
				grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
				gap: 0.9rem;
				padding: 0;
				list-style: none;
			}
			.subject-grid li {
				margin: 0;
			}
			.subject-grid a {
				display: block;
				border: 1px solid rgba(255, 255, 255, 0.08);
				border-radius: 10px;
				padding: 0.95rem 1rem;
				background: rgba(10, 10, 10, 0.85);
				text-decoration: none;
			}
			.subject-grid h2 {
				margin: 0;
				font-size: 1.1rem;
			}
			.subject-grid p {
				margin: 0.25rem 0 0;
				font-size: 0.84rem;
				color: rgb(var(--gray));
			}
		</style>
	</head>
	<body>
		<Header />
		<main>
			<h1>Portfolio</h1>
			{
				subjects.length > 0 ? (
					<ul class="subject-grid">
						{
							subjects.map((subject) => (
								<li>
									<a href={`/portfolio/photos/${encodeURIComponent(subject.slug)}/`}>
										<h2>{subject.label}</h2>
										<p>{subject.count} photos</p>
									</a>
								</li>
							))
						}
					</ul>
				) : (
					<p>
						No subject folders with images found yet. Add images under
						<code>public/media/photos/&lt;subject&gt;</code> and refresh.
					</p>
				)
			}
		</main>
		<Footer />
	</body>
</html>
